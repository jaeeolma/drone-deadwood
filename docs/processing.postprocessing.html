---

title: Postprocessing


keywords: fastai
sidebar: home_sidebar

summary: "Smoothing, combining etc."
description: "Smoothing, combining etc."
nb_path: "nbs/13_processing.postprocessing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/13_processing.postprocessing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Non-maximum-suppression">Non-maximum suppression<a class="anchor-link" href="#Non-maximum-suppression"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First the commonly used NMS with bounding boxes, that prioritizes either confidence score (default) or bounding box area.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="non_max_suppression_fast" class="doc_header"><code>non_max_suppression_fast</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>non_max_suppression_fast</code>(<strong><code>boxes</code></strong>, <strong><code>scores</code></strong>, <strong><code>overlap_thresh</code></strong>:<code>float</code>, <strong><code>sort_criterion</code></strong>:<code>str</code>=<em><code>'score'</code></em>)</p>
</blockquote>
<p>Possibility to sort boxes by score (default) or area</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Non-max suppression can in theory be applied also on polygons, but it hasn't been used in any publications as far as I know.</p>
<p>If <a href="/drone_detector/processing.postprocessing.html#non_max_suppression_poly"><code>non_max_suppression_poly</code></a> is used to eliminate polygons, threshold might need to be smaller than typical value of 0.7 that is used.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="non_max_suppression_poly" class="doc_header"><code>non_max_suppression_poly</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L88" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>non_max_suppression_poly</code>(<strong><code>geoms</code></strong>, <strong><code>scores</code></strong>, <strong><code>overlap_thresh</code></strong>:<code>float</code>, <strong><code>sort_criterion</code></strong>:<code>str</code>=<em><code>'score'</code></em>)</p>
</blockquote>
<p>Possibility to sort geoms by score (default) or area</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some utils to run above functions to <code>GeoDataFrames</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_nms" class="doc_header"><code>do_nms</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L133" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_nms</code>(<strong><code>gdf</code></strong>:<code>GeoDataFrame</code>, <strong><code>nms_thresh</code></strong>=<em><code>0.7</code></em>, <strong><code>crit</code></strong>=<em><code>'score'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_poly_nms" class="doc_header"><code>do_poly_nms</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L141" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_poly_nms</code>(<strong><code>gdf</code></strong>:<code>GeoDataFrame</code>, <strong><code>nms_thresh</code></strong>=<em><code>0.1</code></em>, <strong><code>crit</code></strong>=<em><code>'score'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_min_rot_rectangle_nms" class="doc_header"><code>do_min_rot_rectangle_nms</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L148" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_min_rot_rectangle_nms</code>(<strong><code>gdf</code></strong>:<code>GeoDataFrame</code>, <strong><code>nms_thresh</code></strong>=<em><code>0.7</code></em>, <strong><code>crit</code></strong>=<em><code>'score'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Weighted-boxes-fusion">Weighted boxes fusion<a class="anchor-link" href="#Weighted-boxes-fusion"> </a></h1><p>Originally presented by <a href="https://arxiv.org/abs/1910.13302">Solovyev et al (2021)</a>, and available in [<a href="https://github.com/ZFTurbo/Weighted-Boxes-Fusion">https://github.com/ZFTurbo/Weighted-Boxes-Fusion</a>]. Code presented here is modified to keep track of original bounding boxes for mask fusion, and due to numpy version requirements we do not use numba here.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As WBF expects normalized coordinates, first some helpers to normalize and denormalize geocoordinates.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="normalize_bbox_coords" class="doc_header"><code>normalize_bbox_coords</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L158" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>normalize_bbox_coords</code>(<strong><code>tot_bounds</code></strong>, <strong><code>bboxes</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="denormalize_bbox_coords" class="doc_header"><code>denormalize_bbox_coords</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L172" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>denormalize_bbox_coords</code>(<strong><code>tot_bounds</code></strong>, <strong><code>bboxes</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="bb_intersection_over_union" class="doc_header"><code>bb_intersection_over_union</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L190" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>bb_intersection_over_union</code>(<strong><code>A</code></strong>, <strong><code>B</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="prefilter_boxes" class="doc_header"><code>prefilter_boxes</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L210" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>prefilter_boxes</code>(<strong><code>boxes</code></strong>, <strong><code>scores</code></strong>, <strong><code>labels</code></strong>, <strong><code>weights</code></strong>, <strong><code>thr</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_weighted_box" class="doc_header"><code>get_weighted_box</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L272" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_weighted_box</code>(<strong><code>boxes</code></strong>, <strong><code>conf_type</code></strong>=<em><code>'avg'</code></em>)</p>
</blockquote>
<p>Create weighted box for set of boxes
:param boxes: set of boxes to fuse
:param conf_type: type of confidence one of 'avg' or 'max'
:return: weighted box (label, score, weight, x1, y1, x2, y2)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_matching_box_quickly" class="doc_header"><code>find_matching_box_quickly</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L302" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_matching_box_quickly</code>(<strong><code>boxes_list</code></strong>, <strong><code>new_box</code></strong>, <strong><code>match_iou</code></strong>)</p>
</blockquote>
<p>Reimplementation of find_matching_box with numpy instead of loops. Gives significant speed up for larger arrays
(~100x). This was previously the bottleneck since the function is called for every entry in the array.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="weighted_boxes_fusion" class="doc_header"><code>weighted_boxes_fusion</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L343" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>weighted_boxes_fusion</code>(<strong><code>boxes_list</code></strong>, <strong><code>scores_list</code></strong>, <strong><code>labels_list</code></strong>, <strong><code>weights</code></strong>=<em><code>None</code></em>, <strong><code>iou_thr</code></strong>=<em><code>0.55</code></em>, <strong><code>skip_box_thr</code></strong>=<em><code>0.0</code></em>, <strong><code>conf_type</code></strong>=<em><code>'avg'</code></em>, <strong><code>allows_overflow</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>:param boxes_list: list of boxes predictions from each model, each box is 4 numbers.
It has 3 dimensions (models_number, model_preds, 4)
Order of boxes: x1, y1, x2, y2. We expect float normalized coordinates [0; 1]
:param scores_list: list of scores for each model
:param labels_list: list of labels for each model
:param weights: list of weights for each model. Default: None, which means weight == 1 for each model
:param iou_thr: IoU value for boxes to be a match
:param skip_box_thr: exclude boxes with score lower than this variable
:param conf_type: how to calculate confidence in weighted boxes. 'avg': average value, 'max': maximum value, 'box_and_model_avg': box and model wise hybrid weighted average, 'absent_model_aware_avg': weighted average that takes into account the absent model.
:param allows_overflow: false if we want confidence score not exceed 1.0
:return: boxes: boxes coordinates (Order of boxes: x1, y1, x2, y2).
:return: scores: confidence scores
:return: labels: boxes labels
:return: originals: original boxes</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The history saving thread hit an unexpected error (OperationalError(&#39;disk I/O error&#39;)).History will not be written to the database.
</pre>
</div>
</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_wbf" class="doc_header"><code>do_wbf</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L432" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_wbf</code>(<strong><code>gdf</code></strong>:<code>GeoDataFrame</code>, <strong><code>iou_thr</code></strong>=<em><code>0.55</code></em>, <strong><code>skip_box_thr</code></strong>=<em><code>0.5</code></em>)</p>
</blockquote>
<p>Run weighted_boxes_fusion and returns a gpd.GeoDataFrame where geometries are replaced by new bounding boxes.
Do not use with instance segmentation data unless you want to replace your results with bounding boxes</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="do_wsf" class="doc_header"><code>do_wsf</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L453" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>do_wsf</code>(<strong><code>gdf</code></strong>:<code>GeoDataFrame</code>, <strong><code>iou_thr</code></strong>=<em><code>0.55</code></em>, <strong><code>skip_box_thr</code></strong>=<em><code>0.5</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Smoothing-and-filling-holes">Smoothing and filling holes<a class="anchor-link" href="#Smoothing-and-filling-holes"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Below functions are run before converting IceVision preds to COCO or shapefile format.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fill_holes" class="doc_header"><code>fill_holes</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L492" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fill_holes</code>(<strong><code>preds</code></strong>:<code>list</code>)</p>
</blockquote>
<p>Run <code>binary_fill_holes</code> to predicted binary masks</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="dilate_erode" class="doc_header"><code>dilate_erode</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/processing/postproc.py#L500" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>dilate_erode</code>(<strong><code>preds</code></strong>:<code>list</code>)</p>
</blockquote>
<p>Run dilation followed by erosion in order to smooth masks</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

