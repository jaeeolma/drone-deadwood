---

title: Custom losses and metrics


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/10_metrics.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10_metrics.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="adjusted_R2Score" class="doc_header"><code>adjusted_R2Score</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L22" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>adjusted_R2Score</code>(<strong><code>r2_score</code></strong>, <strong><code>n</code></strong>, <strong><code>k</code></strong>)</p>
</blockquote>
<p>Calculates adjusted_R2Score based on r2_score, number of observations (n) and number of predictor variables(k)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>BigEarthNet metrics</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="label_ranking_average_precision_score" class="doc_header"><code>label_ranking_average_precision_score</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L56" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>label_ranking_average_precision_score</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Label ranking average precision (LRAP) is the average over each ground truth label assigned to each sample,
of the ratio of true vs. total labels with lower score.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="label_ranking_loss" class="doc_header"><code>label_ranking_loss</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L65" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>label_ranking_loss</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Compute the average number of label pairs that are incorrectly ordered given y_score
weighted by the size of the label set and the number of labels not in the label set.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="coverage_error" class="doc_header"><code>coverage_error</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L86" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>coverage_error</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Compute how far we need to go through the ranked scores to cover all true labels.
The best value is equal to the average number of labels in y_true per sample.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">Learner</span>
<span class="k">class</span> <span class="nc">TstLearner</span><span class="p">(</span><span class="n">Learner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>

<span class="k">def</span> <span class="nf">compute_val</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">met</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="n">learn</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],(</span><span class="n">x2</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],)</span>
        <span class="n">met</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">met</span><span class="o">.</span><span class="n">value</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lrap</span> <span class="o">=</span> <span class="n">label_ranking_average_precision_score</span><span class="p">()</span>
<span class="n">lrl</span> <span class="o">=</span> <span class="n">label_ranking_loss</span><span class="p">()</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">coverage_error</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">x_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">x_1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x_1</span><span class="p">),</span> <span class="n">x_2</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[-0.7139, -1.1197,  1.3219, -0.8929, -0.0864, -1.0797, -1.1980, -1.1462,
           0.7752, -0.3072],
         [ 0.0160,  0.4422,  0.7312, -0.2738, -1.8118, -1.0051, -0.8846,  1.3535,
           0.4079,  1.8772],
         [-1.4298,  0.9177, -0.1495,  0.8309, -0.4060, -1.6582, -1.7383,  1.2100,
          -0.4028,  0.3403],
         [ 0.3563, -0.3367, -0.4472,  1.3416,  1.7071,  0.1720,  0.6515, -0.9848,
           1.3077, -0.0549],
         [-1.3293,  0.7442,  1.0438,  0.8183, -0.0366,  0.5047, -0.6310, -1.1718,
           0.1838,  0.2767],
         [-0.2497, -2.2051, -1.1139,  0.0787,  0.7320, -0.4195, -0.9570,  2.4100,
          -1.0918,  0.7197],
         [-0.5669,  1.1043,  0.7297, -0.3731,  1.2886, -0.6209, -0.7776,  1.3258,
           0.4056, -1.2151],
         [ 0.5525,  0.0561, -0.5651, -0.9875,  0.4355,  0.5439,  1.4667, -0.0607,
           0.5053, -0.5647],
         [ 0.0292, -2.3633, -0.6284,  0.9104, -0.5364, -0.8675, -0.3276, -0.5341,
           0.5528, -0.4312],
         [ 0.0761, -0.8560,  1.3815, -1.7832,  0.0498, -1.4050,  1.9722, -0.7927,
          -2.4473,  0.2011]]),
 tensor([[0.3287, 0.2461, 0.7895, 0.2905, 0.4784, 0.2536, 0.2318, 0.2412, 0.6846,
          0.4238],
         [0.5040, 0.6088, 0.6751, 0.4320, 0.1404, 0.2679, 0.2922, 0.7947, 0.6006,
          0.8673],
         [0.1931, 0.7146, 0.4627, 0.6966, 0.3999, 0.1600, 0.1495, 0.7703, 0.4006,
          0.5843],
         [0.5881, 0.4166, 0.3900, 0.7928, 0.8465, 0.5429, 0.6573, 0.2719, 0.7871,
          0.4863],
         [0.2093, 0.6779, 0.7396, 0.6939, 0.4909, 0.6236, 0.3473, 0.2365, 0.5458,
          0.5687],
         [0.4379, 0.0993, 0.2472, 0.5197, 0.6752, 0.3966, 0.2775, 0.9176, 0.2513,
          0.6725],
         [0.3619, 0.7511, 0.6747, 0.4078, 0.7839, 0.3496, 0.3148, 0.7902, 0.6000,
          0.2288],
         [0.6347, 0.5140, 0.3624, 0.2714, 0.6072, 0.6327, 0.8126, 0.4848, 0.6237,
          0.3624],
         [0.5073, 0.0860, 0.3479, 0.7131, 0.3690, 0.2958, 0.4188, 0.3696, 0.6348,
          0.3938],
         [0.5190, 0.2982, 0.7992, 0.1439, 0.5125, 0.1970, 0.8778, 0.3116, 0.0796,
          0.5501]]),
 tensor([[1, 1, 1, 0, 0, 0, 0, 0, 0, 1],
         [1, 1, 1, 0, 0, 1, 1, 1, 1, 0],
         [1, 0, 0, 1, 1, 1, 1, 1, 1, 0],
         [1, 1, 0, 0, 1, 1, 1, 0, 1, 0],
         [0, 0, 1, 0, 1, 1, 0, 0, 1, 0],
         [1, 1, 1, 1, 0, 1, 0, 1, 0, 1],
         [0, 1, 0, 1, 1, 0, 0, 1, 1, 1],
         [0, 1, 1, 0, 0, 1, 0, 0, 0, 1],
         [0, 0, 1, 1, 1, 0, 0, 0, 1, 0],
         [1, 0, 1, 1, 1, 1, 0, 1, 0, 0]]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">lrl</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.4375</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">lrap</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.6836692176870748</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>8.8</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_error</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.3000)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

