---

title: Custom losses and metrics


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/10_metrics.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10_metrics.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="General-metrics-to-use-in-training-and-such">General metrics to use in training and such<a class="anchor-link" href="#General-metrics-to-use-in-training-and-such"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="adjusted_R2Score" class="doc_header"><code>adjusted_R2Score</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>adjusted_R2Score</code>(<strong><code>r2_score</code></strong>, <strong><code>n</code></strong>, <strong><code>k</code></strong>)</p>
</blockquote>
<p>Calculates adjusted_R2Score based on r2_score, number of observations (n) and number of predictor variables(k)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>BigEarthNet metrics</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="label_ranking_average_precision_score" class="doc_header"><code>label_ranking_average_precision_score</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L57" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>label_ranking_average_precision_score</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Label ranking average precision (LRAP) is the average over each ground truth label assigned to each sample,
of the ratio of true vs. total labels with lower score.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="label_ranking_loss" class="doc_header"><code>label_ranking_loss</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L66" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>label_ranking_loss</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Compute the average number of label pairs that are incorrectly ordered given y_score
weighted by the size of the label set and the number of labels not in the label set.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="coverage_error" class="doc_header"><code>coverage_error</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L87" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>coverage_error</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Compute how far we need to go through the ranked scores to cover all true labels.
The best value is equal to the average number of labels in y_true per sample.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">Learner</span>
<span class="k">class</span> <span class="nc">TstLearner</span><span class="p">(</span><span class="n">Learner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>

<span class="k">def</span> <span class="nf">compute_val</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">met</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="n">learn</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],(</span><span class="n">x2</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],)</span>
        <span class="n">met</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">met</span><span class="o">.</span><span class="n">value</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lrap</span> <span class="o">=</span> <span class="n">label_ranking_average_precision_score</span><span class="p">()</span>
<span class="n">lrl</span> <span class="o">=</span> <span class="n">label_ranking_loss</span><span class="p">()</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">coverage_error</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">x_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">x_1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x_1</span><span class="p">),</span> <span class="n">x_2</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[ 1.0280, -1.0610, -0.1173, -0.7883, -0.8184,  0.5261, -0.6622,  1.1560,
           0.8449, -0.4004],
         [ 0.4313,  0.8292,  0.4954,  0.8532,  1.3986, -0.3105,  0.1570, -0.6618,
           1.2155, -0.9401],
         [-1.0522, -1.2088,  0.2641,  1.4395,  0.3363,  0.3853,  0.5344,  0.3369,
           0.0724, -2.2468],
         [-1.2122,  0.2162, -1.7888, -0.2223,  0.9674, -1.8560,  0.2529,  0.3523,
           0.8188, -0.7216],
         [-0.1320,  0.2613,  0.5986, -0.3746, -0.8856,  0.4634,  1.7448,  0.4936,
          -0.5136,  0.1216],
         [ 0.6040, -1.0074,  0.0704, -1.6517,  0.4883,  0.4710,  0.7405, -1.4311,
           0.4396, -0.0408],
         [-0.8344,  0.6181,  0.1578,  0.9650, -1.4521, -2.2841,  0.6757, -0.0121,
          -0.7634, -0.1703],
         [-1.0496,  0.3923, -0.4744,  1.2498, -1.4219, -2.0286,  0.9921, -1.0297,
          -1.3029,  0.3966],
         [ 0.5969,  0.7362, -0.4522,  0.2777,  1.2189,  0.0838,  0.3053,  0.7826,
           0.3143, -0.1105],
         [-0.8890, -0.4088,  0.1404,  0.3297,  0.8804,  0.3141, -0.1647,  0.4410,
           0.0866, -0.1965]]),
 tensor([[0.7365, 0.2571, 0.4707, 0.3125, 0.3061, 0.6286, 0.3402, 0.7606, 0.6995,
          0.4012],
         [0.6062, 0.6962, 0.6214, 0.7012, 0.8020, 0.4230, 0.5392, 0.3403, 0.7713,
          0.2809],
         [0.2588, 0.2299, 0.5656, 0.8084, 0.5833, 0.5952, 0.6305, 0.5834, 0.5181,
          0.0956],
         [0.2293, 0.5538, 0.1432, 0.4446, 0.7246, 0.1352, 0.5629, 0.5872, 0.6940,
          0.3270],
         [0.4671, 0.5649, 0.6453, 0.4074, 0.2920, 0.6138, 0.8513, 0.6210, 0.3743,
          0.5304],
         [0.6466, 0.2675, 0.5176, 0.1609, 0.6197, 0.6156, 0.6771, 0.1929, 0.6082,
          0.4898],
         [0.3027, 0.6498, 0.5394, 0.7241, 0.1897, 0.0924, 0.6628, 0.4970, 0.3179,
          0.4575],
         [0.2593, 0.5968, 0.3836, 0.7773, 0.1944, 0.1162, 0.7295, 0.2632, 0.2137,
          0.5979],
         [0.6450, 0.6762, 0.3888, 0.5690, 0.7719, 0.5209, 0.5757, 0.6862, 0.5779,
          0.4724],
         [0.2913, 0.3992, 0.5350, 0.5817, 0.7069, 0.5779, 0.4589, 0.6085, 0.5216,
          0.4510]]),
 tensor([[0, 0, 1, 1, 0, 0, 0, 1, 1, 1],
         [0, 0, 1, 1, 1, 1, 0, 0, 0, 1],
         [0, 1, 0, 0, 1, 1, 0, 1, 1, 1],
         [1, 1, 1, 1, 1, 0, 1, 0, 0, 0],
         [0, 0, 0, 0, 0, 1, 1, 1, 1, 1],
         [1, 0, 1, 0, 1, 0, 1, 0, 0, 0],
         [1, 0, 1, 0, 0, 1, 1, 0, 1, 0],
         [0, 0, 0, 0, 1, 1, 0, 0, 0, 1],
         [0, 1, 0, 0, 1, 0, 0, 0, 0, 0],
         [0, 1, 1, 0, 1, 1, 0, 0, 1, 0]]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">lrl</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.4276071428571429</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">lrap</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.6481230158730158</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>8.4</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_error</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.3000)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Segmentation-metrics">Segmentation metrics<a class="anchor-link" href="#Segmentation-metrics"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="JaccardCoeffMulti" class="doc_header"><code>class</code> <code>JaccardCoeffMulti</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L96" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>JaccardCoeffMulti</code>(<strong><code>axis</code></strong>=<em><code>1</code></em>) :: <code>DiceMulti</code></p>
</blockquote>
<p>Averaged Jaccard coefficient for multiclass target in segmentation. Includes background as one class</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">JaccardCoeffMulti</span><span class="p">(),</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.11229420131493545</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Object-detection-metrics-and-evaluation-for-shapefiles">Object detection metrics and evaluation for shapefiles<a class="anchor-link" href="#Object-detection-metrics-and-evaluation-for-shapefiles"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To evaluate our collection of predicted masks, we'll compare each of our predicted masks with each of the available target masks for a given input.</p>
<ul>
<li>A <strong>true positive</strong>, when a prediction-target mask pair has an IoU score which exceeds some predefined threshold</li>
<li>A <strong>false positive</strong>, when a predicted object had no associated ground truth object mask</li>
<li>A <strong>false negative</strong> indicates a ground truth object mask had no associated predicted object mask</li>
</ul>
<p>In the case of multiple detections, the one with the highest confidence is considered to be "correct" and others are FP.</p>
<p>From these, we can get <strong>Precision</strong> and <strong>Recall</strong></p>
<p>$Precision = \frac{TP}{TP + FP} = \frac{TP}{all \: detections}, Recall = \frac{TP}{TP+FN} = \frac{TP}{all \: ground \: truths}$</p>
<p>And use these to derive other metrics.</p>
<p>Typical metrics include <strong>Average Precision</strong> (AP) and <strong>mean Average Precision</strong> (mAP). From these several metrics can be derived:</p>
<ul>
<li>AP50, AP75, AP[.50:.05:.95] are the most common, with AP[.50:.05:.95] being the primary challenge metric in COCO</li>
<li>AP Across scales: AP<sub>small</sub>, AP<sub>medium</sub>, AP<sub>large</sub>, where small, medium and large have specified areas<ul>
<li>Scales for COCO are less than 32² for small, between 32² and 96² for medium and more than 96² for large, sizes in pixels</li>
<li>Our data has variable resolution sizes, but on average the resolution is around 0.05m, so small is less than 2.56m², medium is between 2.56m² and 23.04m², and large is more than 23.04m²</li>
</ul>
</li>
<li><strong>Average Recall</strong> (AR) is also sometimes used similarly, but with restrictions for the number of detections per image   <ul>
<li>It is computed as the area under Recall-IoU -curve for IoU thresholds from [0.5, 1]</li>
</ul>
</li>
<li>All of these can be applied to bounding boxes and masks</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All the following functions assume that you have two <code>GeoDataFrame</code>s that have same CRS and matching column <code>label</code>. Usage example is the following:</p>
<div class="highlight"><pre><span></span><span class="n">ground_truth</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="o">&lt;</span><span class="n">path_to_ground_truth</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="o">&lt;</span><span class="n">path_to_results</span><span class="o">&gt;</span><span class="p">)</span>

<span class="c1"># clip the geodataframes to have same extent</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">),</span> <span class="n">keep_geom_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">),</span> <span class="n">keep_geom_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># create spatial index for faster queries                         </span>
<span class="n">res_sindex</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">sindex</span>
<span class="n">gt_sindex</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">sindex</span>

<span class="c1"># TP/FN check with different thresholds, applied to ground truth</span>
<span class="n">tp_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;TP_</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.04</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)]</span>
<span class="n">ground_truth</span><span class="p">[</span><span class="n">tp_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_true_positive</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">res_sindex</span><span class="p">),</span> 
                                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>

<span class="c1"># TP/FP check with different thresholds, applied to predictions</span>
<span class="n">fp_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;FP_</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)]</span>
<span class="n">results</span><span class="p">[</span><span class="n">fp_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_false_positive</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">gt_sindex</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">res_sindex</span><span class="p">),</span> 
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="poly_IoU" class="doc_header"><code>poly_IoU</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L107" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>poly_IoU</code>(<strong><code>poly_1</code></strong>:<code>Polygon</code>, <strong><code>poly_2</code></strong>:<code>Polygon</code>)</p>
</blockquote>
<p>IoU for polygons</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="is_true_positive" class="doc_header"><code>is_true_positive</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L115" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>is_true_positive</code>(<strong><code>row</code></strong>, <strong><code>results</code></strong>:<code>GeoDataFrame</code>, <strong><code>res_sindex</code></strong>:<code>geopandas.sindex</code>)</p>
</blockquote>
<p>Check if a single ground truth mask is TP or FN with 11 different IoU thresholds</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="is_false_positive" class="doc_header"><code>is_false_positive</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L148" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>is_false_positive</code>(<strong><code>row</code></strong>, <strong><code>ground_truth</code></strong>:<code>GeoDataFrame</code>, <strong><code>gt_sindex</code></strong>:<code>geopandas.sindex</code>, <strong><code>results</code></strong>:<code>GeoDataFrame</code>, <strong><code>res_sindex</code></strong>:<code>geopandas.sindex</code>)</p>
</blockquote>
<p>Check if prediction is FP or TP for 11 different IoU thresholds</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/drone_detector/metrics.html#average_precision"><code>average_precision</code></a> and <a href="/drone_detector/metrics.html#average_recall"><code>average_recall</code></a> both return <code>dict</code> of the results, with each label and each IoU threshold separately. Each item is 11 item list where each item correspond to a different recall threshold in the range of [0:.1:1] in the case of <a href="/drone_detector/metrics.html#average_precision"><code>average_precision</code></a>, or IoU threshold in the range of [.50:.05:1] in for <a href="/drone_detector/metrics.html#average_recall"><code>average_recall</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="average_precision" class="doc_header"><code>average_precision</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L219" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>average_precision</code>(<strong><code>ground_truth</code></strong>:<code>GeoDataFrame</code>, <strong><code>preds</code></strong>:<code>GeoDataFrame</code>)</p>
</blockquote>
<p>Get 11-point AP score for each label separately and with all iou_thresholds</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="average_recall" class="doc_header"><code>average_recall</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L261" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>average_recall</code>(<strong><code>ground_truth</code></strong>:<code>GeoDataFrame</code>, <strong><code>preds</code></strong>:<code>GeoDataFrame</code>, <strong><code>max_detections</code></strong>:<code>int</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Get 11-point AR score for each label separately and with all iou_thresholds.
If <code>max_detections</code> is not <code>None</code> evaluate with only that most confident predictions
Seems to be still bugged, needs fixing</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Object-detection-metrics-with-pycocotools-and-gis-data">Object detection metrics with pycocotools and gis-data<a class="anchor-link" href="#Object-detection-metrics-with-pycocotools-and-gis-data"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Run <a href="/drone_detector/predict.html#predict_instance_masks"><code>predict_instance_masks</code></a> or <a href="/drone_detector/predict.html#predict_bboxes"><code>predict_bboxes</code></a> for each scene separately, and save the resulting files in <code>data_path</code> containing</p>
<ul>
<li>folder <code>raster_tiles</code> that contain the corresponding raster data. Required for transforming shapefiles to pixel coordinates</li>
<li>folder <code>vector_tiles</code> that contain ground truth masks</li>
<li>folder <code>predicted_vectors</code> that contain predictions</li>
</ul>
<p>All files corresponding to the same scene should have the same name, e.g. <code>raster_tiles/1053_Hiidenportti_Chunk9_orto.tif</code> for raster image, <code>vector_tiles/1053_Hiidenportti_Chunk9_orto.geojson</code> for ground truth and <code>predicted_vectors/1053_Hiidenportti_Chunk9_orto.geojson</code> for predictions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GisCOCOeval" class="doc_header"><code>class</code> <code>GisCOCOeval</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L298" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GisCOCOeval</code>(<strong><code>data_path</code></strong>:<code>str</code>, <strong><code>outpath</code></strong>:<code>str</code>, <strong><code>coco_info</code></strong>:<code>dict</code>, <strong><code>coco_licenses</code></strong>:<code>list</code>, <strong><code>coco_categories</code></strong>:<code>list</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

