---

title: Custom losses and metrics


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/01_metrics.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_metrics.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="General-metrics-to-use-in-training-and-such">General metrics to use in training and such<a class="anchor-link" href="#General-metrics-to-use-in-training-and-such"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="adjusted_R2Score" class="doc_header"><code>adjusted_R2Score</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>adjusted_R2Score</code>(<strong><code>r2_score</code></strong>, <strong><code>n</code></strong>, <strong><code>k</code></strong>)</p>
</blockquote>
<p>Calculates adjusted_R2Score based on r2_score, number of observations (n) and number of predictor variables(k)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>BigEarthNet metrics</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="label_ranking_average_precision_score" class="doc_header"><code>label_ranking_average_precision_score</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L57" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>label_ranking_average_precision_score</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Label ranking average precision (LRAP) is the average over each ground truth label assigned to each sample,
of the ratio of true vs. total labels with lower score.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The history saving thread hit an unexpected error (OperationalError(&#39;disk I/O error&#39;)).History will not be written to the database.
</pre>
</div>
</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="label_ranking_loss" class="doc_header"><code>label_ranking_loss</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L66" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>label_ranking_loss</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Compute the average number of label pairs that are incorrectly ordered given y_score
weighted by the size of the label set and the number of labels not in the label set.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="coverage_error" class="doc_header"><code>coverage_error</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L87" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>coverage_error</code>(<strong><code>sigmoid</code></strong>=<em><code>True</code></em>, <strong><code>sample_weight</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Compute how far we need to go through the ranked scores to cover all true labels.
The best value is equal to the average number of labels in y_true per sample.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">Learner</span>
<span class="k">class</span> <span class="nc">TstLearner</span><span class="p">(</span><span class="n">Learner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>

<span class="k">def</span> <span class="nf">compute_val</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">met</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span><span class="n">learn</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],(</span><span class="n">x2</span><span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],)</span>
        <span class="n">met</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">met</span><span class="o">.</span><span class="n">value</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lrap</span> <span class="o">=</span> <span class="n">label_ranking_average_precision_score</span><span class="p">()</span>
<span class="n">lrl</span> <span class="o">=</span> <span class="n">label_ranking_loss</span><span class="p">()</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">coverage_error</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">x_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">x_1</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x_1</span><span class="p">),</span> <span class="n">x_2</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[ 0.3585,  0.3680,  0.6514,  1.5930,  0.2598,  0.2434, -0.6264, -0.2699,
          -1.0050, -1.7076],
         [ 1.0638,  0.9787,  0.6562, -0.8399,  1.4551,  0.7271,  0.9793,  0.9989,
           0.4574,  0.0196],
         [-2.7022,  0.7455, -0.0047,  0.3834,  1.0992,  3.0901, -0.2522,  1.4631,
           1.0721, -0.8882],
         [-0.7742,  0.0425, -0.4110,  0.5098, -0.2694,  0.1565, -0.6244, -2.6780,
           1.0883, -2.6456],
         [ 0.1384, -1.4493,  0.4813, -0.0430,  0.5713, -1.2898,  2.2446,  1.7389,
          -0.4202,  1.5950],
         [-0.6502, -0.2301, -0.9330,  0.0203, -0.0237, -0.4158, -0.1419, -0.8124,
           0.3511, -1.3699],
         [-1.2256, -0.0793,  1.2400,  1.3992, -0.2834,  0.6051, -0.1912,  0.6599,
           0.6293, -0.0768],
         [ 1.0593, -0.2375,  0.1191,  1.7870, -0.1336, -0.5772, -0.7763,  1.6647,
           0.9589,  0.1970],
         [-1.7062,  1.8230,  0.1338,  0.2361, -0.3634, -0.0267, -0.0054, -0.4062,
          -1.0068, -0.3750],
         [ 1.2329,  0.7175, -0.3885, -0.3418, -0.0401,  0.5370, -0.3673,  0.0763,
          -0.1656,  0.6642]]),
 tensor([[0.5887, 0.5910, 0.6573, 0.8310, 0.5646, 0.5606, 0.3483, 0.4329, 0.2680,
          0.1535],
         [0.7434, 0.7268, 0.6584, 0.3016, 0.8108, 0.6742, 0.7270, 0.7308, 0.6124,
          0.5049],
         [0.0628, 0.6782, 0.4988, 0.5947, 0.7501, 0.9565, 0.4373, 0.8120, 0.7450,
          0.2915],
         [0.3156, 0.5106, 0.3987, 0.6248, 0.4331, 0.5390, 0.3488, 0.0643, 0.7481,
          0.0663],
         [0.5345, 0.1901, 0.6181, 0.4892, 0.6391, 0.2159, 0.9042, 0.8505, 0.3965,
          0.8313],
         [0.3429, 0.4427, 0.2823, 0.5051, 0.4941, 0.3975, 0.4646, 0.3074, 0.5869,
          0.2026],
         [0.2269, 0.4802, 0.7756, 0.8021, 0.4296, 0.6468, 0.4524, 0.6592, 0.6523,
          0.4808],
         [0.7426, 0.4409, 0.5297, 0.8566, 0.4667, 0.3596, 0.3151, 0.8409, 0.7229,
          0.5491],
         [0.1537, 0.8609, 0.5334, 0.5588, 0.4101, 0.4933, 0.4987, 0.3998, 0.2676,
          0.4073],
         [0.7743, 0.6721, 0.4041, 0.4154, 0.4900, 0.6311, 0.4092, 0.5191, 0.4587,
          0.6602]]),
 tensor([[1, 0, 0, 1, 0, 1, 1, 0, 0, 1],
         [1, 1, 1, 0, 1, 0, 1, 1, 1, 0],
         [0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
         [1, 0, 0, 0, 0, 1, 0, 0, 0, 0],
         [0, 0, 0, 1, 0, 0, 0, 0, 0, 0],
         [1, 1, 1, 0, 0, 0, 0, 1, 1, 0],
         [1, 0, 1, 1, 0, 0, 1, 0, 1, 0],
         [0, 1, 1, 0, 1, 0, 0, 0, 1, 1],
         [1, 1, 0, 1, 0, 0, 1, 1, 0, 1],
         [1, 1, 0, 1, 1, 1, 1, 1, 0, 0]]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">lrl</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.4546904761904761</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">lrap</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.6061218820861678</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>8.7</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">one_error</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(0.3000)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Segmentation-metrics">Segmentation metrics<a class="anchor-link" href="#Segmentation-metrics"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="JaccardCoeffMulti" class="doc_header"><code>class</code> <code>JaccardCoeffMulti</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L96" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>JaccardCoeffMulti</code>(<strong><code>axis</code></strong>=<em><code>1</code></em>) :: <code>DiceMulti</code></p>
</blockquote>
<p>Averaged Jaccard coefficient for multiclass target in segmentation. Excludes background class</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">compute_val</span><span class="p">(</span><span class="n">JaccardCoeffMulti</span><span class="p">(),</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.11792630472515542</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Object-detection-metrics-and-evaluation-for-shapefiles-MOSTLY-OBSOLETE,-USE-GisCOCOEval-instead">Object detection metrics and evaluation for shapefiles MOSTLY OBSOLETE, USE GisCOCOEval instead<a class="anchor-link" href="#Object-detection-metrics-and-evaluation-for-shapefiles-MOSTLY-OBSOLETE,-USE-GisCOCOEval-instead"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To evaluate our collection of predicted masks, we'll compare each of our predicted masks with each of the available target masks for a given input.</p>
<ul>
<li>A <strong>true positive</strong>, when a prediction-target mask pair has an IoU score which exceeds some predefined threshold</li>
<li>A <strong>false positive</strong>, when a predicted object had no associated ground truth object mask</li>
<li>A <strong>false negative</strong> indicates a ground truth object mask had no associated predicted object mask</li>
</ul>
<p>In the case of multiple detections, the one with the highest confidence is considered to be "correct" and others are FP.</p>
<p>From these, we can get <strong>Precision</strong> and <strong>Recall</strong></p>
<p>$Precision = \frac{TP}{TP + FP} = \frac{TP}{all \: detections}, Recall = \frac{TP}{TP+FN} = \frac{TP}{all \: ground \: truths}$</p>
<p>And use these to derive other metrics.</p>
<p>Typical metrics include <strong>Average Precision</strong> (AP) and <strong>mean Average Precision</strong> (mAP). From these several metrics can be derived:</p>
<ul>
<li>AP50, AP75, AP[.50:.05:.95] are the most common, with AP[.50:.05:.95] being the primary challenge metric in COCO</li>
<li>AP Across scales: AP<sub>small</sub>, AP<sub>medium</sub>, AP<sub>large</sub>, where small, medium and large have specified areas<ul>
<li>Scales for COCO are less than 32² for small, between 32² and 96² for medium and more than 96² for large, sizes in pixels</li>
<li>Our data has variable resolution sizes, but on average the resolution is around 0.05m, so small is less than 2.56m², medium is between 2.56m² and 23.04m², and large is more than 23.04m²</li>
</ul>
</li>
<li><strong>Average Recall</strong> (AR) is also sometimes used similarly, but with restrictions for the number of detections per image   <ul>
<li>It is computed as the area under Recall-IoU -curve for IoU thresholds from [0.5, 1]</li>
</ul>
</li>
<li>All of these can be applied to bounding boxes and masks</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All the following functions assume that you have two <code>GeoDataFrame</code>s that have same CRS and matching column <code>label</code>. Usage example is the following:</p>
<div class="highlight"><pre><span></span><span class="n">ground_truth</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="o">&lt;</span><span class="n">path_to_ground_truth</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="o">&lt;</span><span class="n">path_to_results</span><span class="o">&gt;</span><span class="p">)</span>

<span class="c1"># clip the geodataframes to have same extent</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">),</span> <span class="n">keep_geom_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">),</span> <span class="n">keep_geom_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># create spatial index for faster queries                         </span>
<span class="n">res_sindex</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">sindex</span>
<span class="n">gt_sindex</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">sindex</span>

<span class="c1"># TP/FN check with different thresholds, applied to ground truth</span>
<span class="n">tp_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;TP_</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.04</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)]</span>
<span class="n">ground_truth</span><span class="p">[</span><span class="n">tp_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_true_positive</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">res_sindex</span><span class="p">),</span> 
                                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>

<span class="c1"># TP/FP check with different thresholds, applied to predictions</span>
<span class="n">fp_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;FP_</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)]</span>
<span class="n">results</span><span class="p">[</span><span class="n">fp_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_false_positive</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">gt_sindex</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">res_sindex</span><span class="p">),</span> 
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="poly_IoU" class="doc_header"><code>poly_IoU</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L108" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>poly_IoU</code>(<strong><code>poly_1</code></strong>:<code>Polygon</code>, <strong><code>poly_2</code></strong>:<code>Polygon</code>)</p>
</blockquote>
<p>IoU for polygons</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="poly_dice" class="doc_header"><code>poly_dice</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L117" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>poly_dice</code>(<strong><code>poly_1</code></strong>:<code>Polygon</code>, <strong><code>poly_2</code></strong>:<code>Polygon</code>)</p>
</blockquote>
<p>Dice for polygons</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="is_true_positive" class="doc_header"><code>is_true_positive</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L124" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>is_true_positive</code>(<strong><code>row</code></strong>, <strong><code>results</code></strong>:<code>GeoDataFrame</code>, <strong><code>res_sindex</code></strong>:<code>geopandas.sindex</code>)</p>
</blockquote>
<p>Check if a single ground truth mask is TP or FN with 11 different IoU thresholds</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="is_false_positive" class="doc_header"><code>is_false_positive</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L157" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>is_false_positive</code>(<strong><code>row</code></strong>, <strong><code>ground_truth</code></strong>:<code>GeoDataFrame</code>, <strong><code>gt_sindex</code></strong>:<code>geopandas.sindex</code>, <strong><code>results</code></strong>:<code>GeoDataFrame</code>, <strong><code>res_sindex</code></strong>:<code>geopandas.sindex</code>)</p>
</blockquote>
<p>Check if prediction is FP or TP for 11 different IoU thresholds</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/drone_detector/metrics.html#average_precision"><code>average_precision</code></a> and <a href="/drone_detector/metrics.html#average_recall"><code>average_recall</code></a> both return <code>dict</code> of the results, with each label and each IoU threshold separately. Each item is 11 item list where each item correspond to a different recall threshold in the range of [0:.1:1] in the case of <a href="/drone_detector/metrics.html#average_precision"><code>average_precision</code></a>, or IoU threshold in the range of [.50:.05:1] in for <a href="/drone_detector/metrics.html#average_recall"><code>average_recall</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="average_precision" class="doc_header"><code>average_precision</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L228" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>average_precision</code>(<strong><code>ground_truth</code></strong>:<code>GeoDataFrame</code>, <strong><code>preds</code></strong>:<code>GeoDataFrame</code>)</p>
</blockquote>
<p>Get 11-point AP score for each label separately and with all iou_thresholds</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="average_recall" class="doc_header"><code>average_recall</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L270" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>average_recall</code>(<strong><code>ground_truth</code></strong>:<code>GeoDataFrame</code>, <strong><code>preds</code></strong>:<code>GeoDataFrame</code>, <strong><code>max_detections</code></strong>:<code>int</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Get 11-point AR score for each label separately and with all iou_thresholds.
If <code>max_detections</code> is not <code>None</code> evaluate with only that most confident predictions
Seems to be still bugged, needs fixing</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Object-detection-metrics-with-pycocotools-and-gis-data">Object detection metrics with pycocotools and gis-data<a class="anchor-link" href="#Object-detection-metrics-with-pycocotools-and-gis-data"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Run <code>predict_instance_masks</code> or <code>predict_bboxes</code> for each scene separately, and save the resulting files in <code>data_path</code> containing</p>
<ul>
<li>folder <code>raster_tiles</code> that contain the corresponding raster data. Required for transforming shapefiles to pixel coordinates</li>
<li>folder <code>vector_tiles</code> that contain ground truth masks</li>
<li>folder <code>predicted_vectors</code> that contain predictions</li>
</ul>
<p>All files corresponding to the same scene should have the same name, e.g. <code>raster_tiles/1053_Hiidenportti_Chunk9_orto.tif</code> for raster image, <code>vector_tiles/1053_Hiidenportti_Chunk9_orto.geojson</code> for ground truth and <code>predicted_vectors/1053_Hiidenportti_Chunk9_orto.geojson</code> for predictions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GisCOCOeval" class="doc_header"><code>class</code> <code>GisCOCOeval</code><a href="https://github.com/jaeeolma/drone_detector/tree/master/drone_detector/metrics.py#L307" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GisCOCOeval</code>(<strong><code>data_path</code></strong>:<code>str</code>, <strong><code>outpath</code></strong>:<code>str</code>, <strong><code>coco_info</code></strong>:<code>dict</code>, <strong><code>coco_licenses</code></strong>:<code>list</code>, <strong><code>coco_categories</code></strong>:<code>list</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

